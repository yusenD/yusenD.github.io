---
layout: post
title: TCP与UDP解析
feature-img: "assets/img/background/pexels-photo17.jpeg"
thumbnail: "assets/img/background/pexels-photo17.jpeg"
tags: [计算机网络]
---

> 念念不忘，必有回响。

<br>

## 传输层协议

传输层的作用主要是实现应用程序之间的通信，主要协议包括**TCP**、**UDP**协议，下面对于这两种协议，进行分别讨论。

## TCP

TCP，全称：传输控制协议「Transmission Control Protocol」，是一种面向连接的传输层协议，在进行通信的时候，需要先建立起可靠的连接。

### TCP数据报头部结构

主要有：

* Source Port 源端口号
* Destination Port 目的端口号
* Sequence Number 序列号：表示发送数据的位置，如果当前序列号为s，发送数据长度为l，那么下次序列号为s+l。建立连接时，通常由计算机生成一个随机数作为序列号的初始值。
* Acknowledgement Number 确认应答号：等于下一次应该接收到的数据的序列号。假设发送端的序列号为s，发送的数据长度为l，那么接收端返回的正确应答号也是s+l。发送端接收到这个ACK之后，可以认为数据已经被正确接收。
* Data Offset 数据偏移：TCP首部的长度，单位为4字节。如果没有可选字段，那么TCP首部的长度为20字节。
* Reserved 保留：
* Control Flag 控制位：CWR ECE URG ACK PSH RST SYN FIN
* Window Size 窗口大小：用于表示从应答号开始，能够接受多少个8位字节。如果窗口大小为0，可以发送窗口探测。
* Checksum 校验和
* Urgent Pointer 紧急指针：在控制位UTG=1时候有效，表示紧急数据的末尾在TCP数据部分的位置，通常在暂停通信是
* Options 选项
* Padding 填充

-----

* Data 数据

### 一些知识点

* TCP提供一种，面向连接的、可靠的字节流服务。
* 在一个TCP连接中，仅有两方进行通信。广播和多播不能用于TCP。
* TCP使用校验和、确认和重传机制来保证可靠数据传输。
* TCP给数据分节进行排序，并使用累计确认保证数据的顺序不变和非重复。
* TCP使用滑动窗口机制来实现流量控制，通过动态改变窗口大小进行拥塞控制。

### TCP的应用场景

* FTP：文件传输协议，使用21端口。
* Telnet：远程登录接口，使用23端口。
* SMTP：邮件传送协议，发送邮件，使用25端口。
* POP3：与SMTP对应，接受邮件，使用110端口。
* HTTP：超文本传输协议，从Web服务器传输超文本到本地浏览器。

一些文件传输，重要状态的更新等

### 三次握手过程🤝

三次握手是指：在建立一个TCP连接的时候，客户端和服务器之间需要发送三个数据包。三次握手的目的是连接服务端指定端口，建立TCP连接，并同步连接双方的序列号和确认号，交换TCP窗口大小信息。在socket编程中，客户端`connect()`的时候，将触发三次握手。

* 第一次握手：客户端发送，SYN包请求建立连接，seq=x，然后进入`SYN_SEND`状态
* 第二次握手：服务端收到SYN，发送ACK(对SYN的确认应答)+SYN（请求建立连接），ACKnum=x+1，seq=y，然后进入`SYN_RCVD`状态。
* 第三次握手：客户端收到SYN，发送ACK(对SYN的确认应答)，ACKnum=y+1。

至此，客户端进入`ESTABLISHED`状态，收到包后，服务端也进入该状态，TCP握手结束，连接已经完成建立，可以进行数据传输。

> 补充：之所以采用三次握手，是为了解决网络中存在延迟的重复分组问题，防止已经失效的连接请求报文段突然又传送到了服务端，从而产生的错误。
> 
> 如果最后一个ACK确认包丢失了，那么服务器端发送RST报文，将连接重置，如果客户端还想建立TCP连接，那么重新开始第一次握手。

<br>

### 四次挥手过程👋

四次挥手是指：在TCP连接拆除的时候，总共需要发送四个包。客户端和服务器均可发起挥手动作。在socket编程中，任意一端执行`close()`即可产生挥手操作。

* 第一次挥手：假设客户端想要关闭连接，则发送一个FIN置位1的包，然后进入`FIN_WAIT_1`状态。
* 第二次挥手：服务器接受到FIN包，发送一个ACK确认包，表示收到了包，但是还没准备好关闭连接，然后进入`CLOSE_WAIT`状态。客户端接收到ACK确认包之后，进入FIN_WAIT_2状态，等待服务器关闭连接。
* 第三次挥手：服务器准备好关闭连接时，向客户端发送结束连接请求包，FIN置1，然后进入`LAST_ACK`状态，等待客户端的最后一个ACK。
* 第四次挥手：客户端收到FIN包后，发送ACK确认包，并进入`TIME_WAIT`状态，等待可能出现的要求重传的ACK包。服务端接收到这个确认包之后，关闭连接，进入`CLODE`状态。客户端等待了一段时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务端的ACK，认为服务端已经正常关闭连接，于是也关闭连接，也进入`CLOSE`状态。

> 补充：之所以最后要等待2MSL，是为了避免最后一个ACK包没有收到，那么对方在超时后，会重新发送第三次握手的FIN包，主动结束端收到FIN包可以再发送一个ACK包。避免干扰第二个连接。

![](https://i.loli.net/2019/03/09/5c836bcc85993.jpg)


## UDP

UDP，全称用户数据报协议「User Data Protocol」，是一种简单的传输层传输层协议，无连接，且不可靠。

### UDP数据报头部结构

主要有：

* Source Port 源端口号
* Destination Port 目标端口号
* Length 包长度：表示UDP头部的长度和UDP数据长度之和
* Checksum 校验和：校验数据在传输过程中是否损坏，计算校验和的时候要考虑源端口号、目标端口号、源IP、目的IP、协议号（被称为UDP的伪首部）。

-----

* Data：数据部分

### 一些知识点

* UDP缺乏可靠性，因为UDP不提供确认、序列号、超时重传等机制。不保证数据包最后会到达也不保证到达先后顺序，也不保证每个数据包只到达一次。
* UDP无连接。
* UDP支持多播和广播。

### UDP的应用场景

* DNS：域名解析服务
* SNMP：简单网络管理协议
* TFTP：简单文件传输协议

一些视频传输、实时通信等

## TCP可靠传输机制

### 滑动窗口协议

滑动窗口协议用于网络数据传输时的流量控制，以避免拥塞的发生。该协议允许发送方在停止并等待确认前发送多个数据分组。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输，提高网络吞吐量。

比如发送四个报文段，然后1、2、4接收方收到了，发送收到1、2的ACK，并且产生保存第三个报文段的空位，将数据缓存起来，接收端的窗口右移，产生新的空位，这些是接收端允许发送方发送的范畴。发送方收到ACK后，窗口就移动两个位置。

如果对于丢失的3，超过一段时间会重新传送，重传成功的话3、4会一同确认，不成功的话4也被舍弃。

* 停止等待
* 后退n步
* 选择重传

### 拥塞控制

思路：发送方维持一个叫做拥塞窗口的状态变量，拥塞窗口的大小取决于网络的拥塞程度，并且在动态的变化。发送方让自己的发送窗口小于等于拥塞窗口。

* 慢开始：开始的时候，每次加一个MSS，之后指数增长，如第二次长度加2个MSS，第三次加4个MSS，当达到上限之后，每次加一个MSS。
* 和式增加，积式减少：拥塞窗口线性增加，当发生拥塞时，积式减少
* 快重传：3个ACK超时重传。

### 具体算法：

* Tahoe：如果收到三次重复确认——即第四次收到相同确认号的分段确认，并且分段对应包无负载分段和无改变接收窗口——的话，Tahoe算法则进入快速重传，将慢启动阈值改为当前拥塞窗口的一半，将拥塞窗口降为1个MSS，并重新进入慢启动阶段。
* Reno：如果收到三次重复确认，Reno算法则进入快速重传，只将拥塞窗口减半来跳过慢启动阶段，将慢启动阈值设为当前新的拥塞窗口值，进入一个称为“快速恢复”的新设计阶段。

### Socket和TCP对应

客户端：connect方法，对应TCP第一次握手
服务器：accept方法，对应收到连接请求

