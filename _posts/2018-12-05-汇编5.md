---
layout: post
title: 汇编（五）——程序控制指令
feature-img: "assets/img/background/pexels-photo15.jpeg"
tags: [汇编]
---

> 芦叶满汀洲，寒沙带浅流。二十年重到南楼。柳下系船犹未稳，能几日，又中秋。 <br>
> 黄鹤断矶头，故人今在否。旧江山浑是新愁。欲买桂花重载酒，终不似，少年游。                          
> <p align="right">——刘过《唐多令》</p>

<br>

## 程序控制类指令

* 程序控制类指令的本质是控制程序的执行方式
* 决定程序执行方向的因素：CS（代码段）和IP

### 1.无条件转移指令

> JMP OPRD(目标地址)

如果在同一代码段叫**段内转移**，否则叫**段间转移**

#### 段内转移：
目标地址是16位偏移地址，有两种：

* 可以直接给出目标地址（段内直接转移）


    > JMP LABEL(近地址标号)，计算位移量，下一条执行指令的偏移地址=IP+位移量


* 也可以由寄存器或存储器指出目标地址（段内间接转移）


    > MOV BX, 1200H
    > 
    > JMP BX
    > 
    > 执行完后，IP=1200H
    
    > MOV BX, 1200
    > 
    > JMP WORD PTR[BX] （到数据段）
    > 
    > 执行完后，1200和1201两个内容会被送到IP里面

    
#### 段间转移

> JMP FAR LABEL(远地址标号)

转移的目标地址由指令中的32位操作数给出，32位的目标地址必须存放于内存中

例如：`JMP DWORD PTR[BX]`

高地址为转移目标的段基地址，低地址为偏移地址

### 2.条件转移地址

* 转移范围非常小，转移范围只有-127-+128，也称段内短转移
* 大部分基于标志位，JCXZ基于CS状态

#### 基于一个标志位的转移

* JC/JNC ： 判断**CF**的状态。常用于两个无符号数大小的比较，JC是CF=1转移，JNC是CF=0的时候转移。
* JZ/JNZ ： 判断**ZF**的状态。常用于循环体结束的判断，JZ是ZF=1转移，JNZ是ZF=0的时候转移。
* JO/JNO ： 判断**OF**的状态。常用于有符号数溢出的判断，同上。
* JP/JEP、JNP/JPO ： 判断**PF**的状态。常用于判断运算结果低8位中1的个数是否为偶数。
* JS/JNS ： 判断SF的状态。常用于判断数的性质。

----

#### 基于两个或三个标志位的转移

* JA/JAE/JAB/JBE ： 判断CF或CF+ZF的状态，常用于无符号数大小的比较。
* JG/JGE/JL/JLE ： 判断SF+OF或SF+OF+ZF的状态。常用于有符号数大小的比较。

----

#### 基于CX内容转移的指令

* JCXZ ： 可根据指令执行后CX的结果实现转移。

----

#### 例子🌰

统计内存数据段中以TABLE为首地址的100个8位带符号数中，正数、负数和零元数的个数。

基本思路：将存放统计值得单元清零，然后读取数，通过统计标志位的状态来判断数的性质，
最高位为1，则为负数。

代码实现：

{% highlight java%}

START: XOR AL, AL
    MOV PLUS, AL
    MOV MINUS, AL
    MOV ZERO, AL
    LEA SI, TABLE
    MOV CX, 100
    CLD
CHECK: LODSB ;因为没有重复前缀，所以读取一个字符串到AL之后，SI加一
    OR AL,AL
    JS X1 ;只关心SF的状态，如果SF为1，则说明为负数
    JZ X2 ;为正数或零再看一下ZF的状态，如果ZF=1，则说明为0 
    INC PLUS ;为正数
    JMP NEXT

X1: INC MINUS
    JMP NEXT
    
X2: INC ZERO

NEXT: DEC CX
    JNZ CHECK ;ZF不为零说明CX不为0，则继续执行
    HLT 

{% endhighlight %}

### 3.循环控制指令

* 循环范围：以当前IP为中心的-128~+127内循环
* 循环次数由CX寄存器指定

#### 无条件循环指令

> LOOP LABEL
> 
>(其实相当于)：
>
> DEC CX
> 
> JNZ LABEL

#### 条件循环指令

先使得CX-1，再根据CX中的值和ZF值来决定是否循环

> LOOPZ LABEL => CX!=0且ZF=1则继续循环
> 
> LOOPNZ LABEL => CX!=0且ZF=0则继续循环

常跟在CMP指令后面，判断ZF状态

例子🌰：在以DATA为首地址的内存数据段中，存放有200个16位有符号数，试找出其中最大和最小的符号数，并且分别放在MAX和MIN为首的内存单元中。

{% highlight java%}

START: LEA SI, DATA
    MOV CX, 200
    CLD
    LODSW
    MOV MAX, AX
    MOV MIN, AX
    DEC CX

NEXT: LODSW
    CMP AX, MAX
    JG LABRGE ;有符号数的比较
    CMP AX, MIN
    JL SMALL
    JMP GOON

LARGE: MOV MAX, AX
    JMP GOON
    
SMALL: MOV MIN, AX

GOON: LOOP NEXT

{% endhighlight %}


### 3.过程调用指令

* 用于调用一个子过程，子过程执行结束之后，要返回原来的调用处（必须保护返回地址）
* 断点/入口地址

#### 段内调用

> CALL TIMER 直接调用
> 
> CALL WORD PTR[SI] 间接调用

#### 段间调用

> CALL FAR TIMER (说明是段间调用)
> 
> CALL DWORD PTR[SI]

#### 返回指令RET

从堆栈中弹出断点地址，返回源程序

子程序最后一条指令必须是RET

### 4.中断指令

> INT n (中断类型码)
> ~~~~
> IRET 中断恢复，是中断服务程序的最后一条指令，负责恢复断点和标志寄存器的内容


n*4:存放中断服务子程序入口地址的单元的偏移地址，该单元在数据段

中断向量表中n\*4和n*4+1指向的内容为偏移地址（IP），n\*4+2和n*4+3指向的地址为段基地址（CS）

### 5.处理器控制指令

重置标志位指令

CLC CF清零
STC CF置1
CMC CF取反
CLD DF清零
STD DF置1
CLI IF清零，即清中断标志位，关中断
STI IF置1，即开中断







